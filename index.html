<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonic Guardian | Acoustic Identity Recovery</title>
    <!-- Load Strudel (Pattern Engine & Audio) -->
    <script src="https://unpkg.com/@strudel/web@1.0.3"></script>
    <!-- Load Acorn (Parser) for our DNA Extractor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/acorn/8.11.3/acorn.min.js"></script>
    <script src="https://unpkg.com/estree-walker@2.0.2/index.js"></script>
    <style>
        :root {
            --bg: #0f0f13;
            --text: #e0e0e0;
            --accent: #00ff9d;
            --error: #ff4757;
            --panel: #1a1a20;
        }
        body {
            font-family: 'Courier New', monospace;
            background: var(--bg);
            color: var(--text);
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 { color: var(--accent); margin-bottom: 0.5rem; }
        .subtitle { opacity: 0.7; margin-bottom: 2rem; display: block; }
        
        .panel {
            background: var(--panel);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid #333;
        }
        
        input, button {
            background: #2a2a35;
            border: 1px solid #444;
            color: white;
            padding: 0.8rem;
            font-family: inherit;
            border-radius: 4px;
            width: 100%;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }
        
        button {
            background: var(--accent);
            color: black;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        
        .hidden { display: none; }
        
        code {
            display: block;
            background: #000;
            padding: 1rem;
            border-radius: 4px;
            color: #bd93f9;
            white-space: pre-wrap;
            margin-top: 1rem;
        }
        
        .status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
        .status.success { background: rgba(0, 255, 157, 0.1); color: var(--accent); border: 1px solid var(--accent); }
        .status.fail { background: rgba(255, 71, 87, 0.1); color: var(--error); border: 1px solid var(--error); }

        #visualizer {
            width: 100%;
            height: 60px;
            background: #000;
            margin-top: 1rem;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <h1>Sonic Guardian</h1>
    <span class="subtitle">Zero-Knowledge Acoustic Identity Recovery for Starknet</span>

    <!-- STEP 1: REGISTRATION -->
    <div class="panel" id="registration-panel">
        <h2>1. Create Identity</h2>
        <p>Enter a "Secret Vibe" only you know. This will generate your acoustic DNA.</p>
        <input type="text" id="secret-prompt" placeholder="e.g. A fast, crunchy techno beat..." value="A slow, muffled industrial bassline">
        <button onclick="generateIdentity()">Generate & Mint Identity</button>
        <div id="identity-result" class="hidden">
            <div id="visualizer"></div>
            <code id="generated-code"></code>
            <div class="status success">
                IDENTITY MINTED<br>
                DNA Hash: <span id="dna-hash"></span>
            </div>
            <button onclick="lockWallet()" style="margin-top:1rem; background: #ff4757; color:white;">Simulate Wallet Lock (Lose Key)</button>
        </div>
    </div>

    <!-- STEP 2: RECOVERY -->
    <div class="panel hidden" id="recovery-panel">
        <h2>2. Recover Wallet</h2>
        <p style="color:var(--error)">⚠️ WALLET LOCKED. KEY LOST.</p>
        <p>To rotate your key, prove you know the Sonic Secret.</p>
        <input type="text" id="recovery-prompt" placeholder="What was your secret vibe?">
        <button onclick="attemptRecovery()">Generate Proof & Recover</button>
        
        <div id="recovery-result" class="hidden">
            <code id="recovery-code"></code>
            <div id="recovery-status" class="status"></div>
        </div>
    </div>

    <script>
        // --- 1. CORE LOGIC (Ported from dna.mjs) ---
        // Simple hash function for browser (SHA-256)
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // DNA Extractor using Acorn (Global)
        async function extractSonicDNA(code) {
            const features = [];
            try {
                const ast = acorn.parse(code, { ecmaVersion: 2022 });
                
                // Simple walker implementation since estree-walker might not be globally exposed as 'walk'
                // We'll do a simple recursive walk for CallExpressions
                function simpleWalk(node) {
                    if (!node) return;
                    
                    if (node.type === 'CallExpression') {
                        let name = '';
                        if (node.callee.type === 'Identifier') name = node.callee.name;
                        else if (node.callee.type === 'MemberExpression') name = node.callee.property.name;

                        if (name) {
                            const args = node.arguments.map(arg => {
                                if (arg.type === 'Literal') return arg.value;
                                return null;
                            }).filter(a => a !== null);
                            
                            // Normalize: Round numbers, lowercase strings
                            const normalizedArgs = args.map(a => {
                                if (typeof a === 'number') return Math.round(a);
                                if (typeof a === 'string') return a.toLowerCase().trim();
                                return a;
                            });
                            features.push({ name, args: normalizedArgs });
                        }
                    }

                    // Recursively walk children (simplified)
                    for (const key in node) {
                        if (typeof node[key] === 'object') {
                            if (Array.isArray(node[key])) node[key].forEach(simpleWalk);
                            else simpleWalk(node[key]);
                        }
                    }
                }
                simpleWalk(ast);

            } catch (e) {
                console.error("Parse error:", e);
                return null;
            }

            // Sort and normalize
            const normalized = features
                .filter(f => f.name !== 'evaluate') 
                .sort((a, b) => a.name.localeCompare(b.name))
                .map(f => `${f.name}(${f.args.join(',')})`)
                .join('|');

            const hash = await sha256(normalized);
            return { dna: normalized, hash };
        }

        // --- 2. MOCK AGENT (Simulates LLM) ---
        // In a real app, this calls Gemini API
        function mockAgentGenerate(prompt) {
            prompt = prompt.toLowerCase();
            
            // Deterministic Logic for Demo
            if (prompt.includes("muffled") || prompt.includes("dark")) {
                // Agent might vary order, but DNA stays same
                return `s("bass").slow(2).distort(5).lpf(500)`;
            } 
            if (prompt.includes("techno") || prompt.includes("fast")) {
                return `stack(s("bd*4"), s("hh*8").gain(0.8))`;
            }
            if (prompt.includes("bright") || prompt.includes("sharp")) {
                return `s("saw").hpf(2000).fast(2)`;
            }
            // Default fallback
            return `s("bd").slow(2)`;
        }

        // --- 3. UI LOGIC ---
        let STORED_HASH = "";

        // Init Strudel
        strudel.initStrudel();

        async function generateIdentity() {
            const prompt = document.getElementById('secret-prompt').value;
            const code = mockAgentGenerate(prompt);
            
            // 1. Play Sound
            evaluate(code); 
            
            // 2. Extract DNA
            const dna = await extractSonicDNA(code);
            STORED_HASH = dna.hash;

            // 3. Update UI
            document.getElementById('generated-code').innerText = code;
            document.getElementById('dna-hash').innerText = dna.hash.substring(0, 16) + "..."; // Show partial hash
            document.getElementById('identity-result').classList.remove('hidden');
        }

        function lockWallet() {
            strudel.hush(); // Stop sound
            document.getElementById('registration-panel').classList.add('hidden');
            document.getElementById('recovery-panel').classList.remove('hidden');
        }

        async function attemptRecovery() {
            const prompt = document.getElementById('recovery-prompt').value;
            const code = mockAgentGenerate(prompt);
            
            // 1. Play Sound (Feedback)
            evaluate(code);
            document.getElementById('recovery-code').innerText = code;
            document.getElementById('recovery-result').classList.remove('hidden');

            // 2. Extract DNA
            const dna = await extractSonicDNA(code);
            
            // 3. Verify
            const statusEl = document.getElementById('recovery-status');
            if (dna.hash === STORED_HASH) {
                statusEl.className = "status success";
                statusEl.innerHTML = `✅ RECOVERY SUCCESSFUL<br>DNA MATCHED: ${dna.hash.substring(0, 16)}...<br>New Private Key Generated.`;
            } else {
                statusEl.className = "status fail";
                statusEl.innerHTML = `❌ RECOVERY FAILED<br>DNA MISMATCH.<br>Expected: ${STORED_HASH.substring(0, 8)}...<br>Got: ${dna.hash.substring(0, 8)}...`;
            }
        }
    </script>
</body>
</html>
